<html>
    <head>
        <script type="text/javascript">
var events = [
    {"type": "message", "id": "018f9a57-6ed4-7ef5-8a86-ca6c5407b004", "nick": "rion", "text": "This is text\nanother line"},
    {"type": "message", "id": "018f9a57-6ed4-7328-976c-090bdbc9aabd", "nick": "rion", "text": "Next message Next message Next message Next message Next message Next message Next message Next message Next message"},
    {"type": "message", "id": "018f9a57-6ed4-7d35-8968-bee2b92ece51", "nick": "rion", "text": "3rd message 3rd message 3rd message 3rd message 3rd message 3rd message 3rd message 3rd message 3rd message 3rd message"},
    {"type": "reaction", "nick": "rion", "target": "018f9a57-6ed4-7328-976c-090bdbc9aabd", "reactions": [{"text": "üòã"}]},
    {"type": "message", "id": "018f9a57-6ed4-7491-9acb-eea4e5a58304", "nick": "nickname", "text": "Another text"},
    {"type": "message", "id": "018f9a57-6ed4-768e-bf78-38165c97481a", "nick": "nickname", "text": "Next in group. Next in group. Next in group. Next in group. Next in group. Next in group. Next in group. Next in group."},
    {"type": "message", "id": "018f9a57-6ed4-75a8-8e06-dc71cf229b22", "nick": "kapad", "text": "i dont know if this easy or not, but i was think something the other day... Let's say, one day you/or some that knows, have some free time and artistic mood. Take a piece of paper and a pen, and draw some important/basic stanza routes with notes of a file/function name. Then post the image..."},
    {"type": "reaction", "nick": "rion", "target": "018f9a57-6ed4-75a8-8e06-dc71cf229b22", "reactions": [{"text": "üëç"}]},
    {"type": "system", "text": "This is a notification"},
    {"type": "reaction", "nick": "rion", "target": "018f9a57-6ed4-75a8-8e06-dc71cf229b22", "reactions": [{"text": "üî•"}, {"text": "üëå"}]},
    {"type": "reaction", "nick": "rion", "target": "018f9a57-6ed4-75a8-8e06-dc71cf229b22", "reactions": [{"text": "üëçüèª", "base": "üëç"}]},
    {"type": "message", "id": "018f9a57-6ed4-7922-b777-28e5a81f74f5", "nick": "rion", "reply": "018f9a57-6ed4-75a8-8e06-dc71cf229b22", "text": "Sounds like a greate idea!"},
    {"type": "message", "id": "018f9a57-6ed4-7525-8d1c-b260860d081a", "nick": "nickname", "reply": "018f9a57-6ed4-7d35-8968-bee2b92ece51", "text": "Stop writing this garbage"},
    {"type": "reaction", "nick": "rion", "target": "018f9a57-6ed4-7525-8d1c-b260860d081a", "reactions": [{"text": "üòù"}]},
    {"type": "message", "id": "018f9a57-6ed4-71c5-9a9b-17e58a81ab10", "nick": "rion", "text": "short message"},
];
/*

018f9a57-6ed4-7796-a02a-b452c43d9ace
018f9a57-6ed4-7e96-b3b5-de083d6091bc
018f9a57-6ed4-722d-bcef-f10a03d82de4
018f9a57-6ed4-74df-a40e-73c2e3be73d8
018f9a57-6ed4-7ff8-9374-c987d9b77448
018f9a57-6ed4-73b1-965e-3e04081499ac
018f9a57-6ed4-7b1c-b649-6a7b8e3b44ca
*/

avatars = {
    "rion": "üò∫",
    "nickname": "üßôüèæ‚Äç‚ôÇÔ∏è",
    "kapad": "ü´µ"
}

const selfNick = "rion";
var prevMessage = {
    "type": undefined,
    "nick": undefined,
};

function fromHTML(html, trim = true) {
  // Process the HTML string.
  html = trim ? html.trim() : html;
  if (!html) return null;

  // Then set up a new template element.
  const template = document.createElement('template');
  template.innerHTML = html;
  const result = template.content.children;

  // Then return either an HTMLElement or HTMLCollection,
  // based on whether the input HTML had one or more roots.
  if (result.length === 1) return result[0];
  return result;
}

function render_message(event) {
    let classes = ["msg"];
    if (prevMessage["type"] == "message" && prevMessage["nick"] == event["nick"]) {
        classes.push("grnext")
    }
    if (event["nick"] == selfNick) {
        classes.push("mymsg");
    }
    classes = classes.join(" ");
    const avatar = new Option(avatars[event["nick"]]).innerHTML;
    const nick = new Option(event["nick"]).innerHTML;
    let msgtext = new Option(event["text"]).innerHTML.replace("\n", "<br/>");
    let quoteMsg = null;
    if (event.reply) {
        quoteMsg = document.getElementById(event.reply);
        if (quoteMsg) {
            const quoteNick = quoteMsg.getElementsByClassName("nick")[0].innerHTML;
            const quoteText = quoteMsg.getElementsByClassName("msgtext")[0].innerHTML;
            msgtext = `<blockquote><div>${quoteNick}</div>${quoteText}</blockquote>` + msgtext;
        }
    }
    const time = (new Date()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    let el = fromHTML(`<div class="${classes}" id="${event.id}">
    <span class="avatar">${avatar}</span>
    <span class="nick">${nick}</span>
    <span class="time">${time}</span>
    <span class="msgtext">${msgtext}</span>
    <div class="reactions"></div>
</div>`);
    document.body.appendChild(el);
    let shared_timer = {}
    el.addEventListener("mouseleave", function(){
        if (shared_timer.timer) { // if we were going to show it
            clearTimeout(shared_timer.timer);
            shared_timer.timer = null;
        } else {
            const rs = el.getElementsByClassName("reactions_selector")[0];
            rs.parentNode.removeChild(rs);
        }
    });
    el.addEventListener("mouseenter", function(){
        shared_timer.timer = setTimeout(function(){
            let selector = el.appendChild(document.createElement("div"));
            selector.classList.add("reactions_selector");
            selector.textContent = "‚ù§";
            setTimeout(()=>{ console.log('adding'); selector.classList.add('noopacity'); }, 0);
            shared_timer.timer = null;
            
        }, 1000);
    });
    if (event.reply) {
        const bq = el.getElementsByTagName("blockquote")[0];
        if (bq) {
            bq.addEventListener("click", () => {quoteMsg.scrollIntoView({"behavior": "smooth", "block": "center"})});
        }
    }
}

function render_reaction(event) {
    const msg = document.getElementById(event.target);
    const reactions = msg?.getElementsByClassName("reactions").item(0);
    if (!reactions) {
        return;
    }
    for (let r = 0; r < event["reactions"].length; r++) {
        const reactionsList = reactions.getElementsByTagName("span");
        const ritem = event["reactions"][r];
        const text = ritem["text"];
        const base = ritem["base"];
        let reaction = null;
        for (let i = 0; i < reactionsList.length; i++) {
            let span = reactionsList[i];
            if (span.baseReaction === base) {
                reaction = span;
                break;
            }
        }
        if (!reaction) {
            reaction = document.createElement("span");
            reaction.baseReaction = (base || text);
            reaction.innerHTML = `1 <em>${text}</em>`;
            reactions.appendChild(reaction);
            continue;
        }

        reaction.firstChild.textContent = (Number(reaction.firstChild.textContent) + 1) + " ";
        const emojis = reaction.getElementsByTagName("em");
        let found = false;
        for (let i = 0; i < emojis.length; i++) {
            if (emojis[i].textContent == text) {
                found = true;
                break;
            }
        }
        if (!found) {
            reaction.appendChild(fromHTML(`<em>${text}</em>`));
        }
    }
}

function render_system(event) {
    let html = new Option(event["text"]).innerHTML;
    document.body.appendChild(fromHTML(`<div class="sysmsg">${html}</div>`));
}

function render(event) {
    switch (event["type"]) {
        case "message": render_message(event); break;
        case "reaction": render_reaction(event); break;
        case "system": render_system(event); break;
    }
    if (event.type === "message" || event.type === "system") {
        prevMessage = {
            "type": event["type"],
            "nick": event["nick"],
        };
    }
    document.body.scrollTo({"top": document.body.scrollHeight, "behavior": "smooth"})
}

function ready() {
    var event = events.shift();
    render(event);
    if (events.length) {
        setTimeout(ready, 100);
    }
}

document.addEventListener("DOMContentLoaded", ready);
        </script>
        <style>
body {
    width: 100%;
    height: 100%;
    padding: .5em 0;
    margin: 0;
    box-sizing: border-box;
    background: url(background.jpg);
    background-attachment: fixed;
    background-size: cover;
    color: black;
    font-family: sans, times;
}

.sysmsg {
    background-color: rgb(122, 246, 246);
    color: #444;
    padding: .4em 1em;
    width: 70%;
    margin: 0 auto .5em;
    border-radius: 1em;
    text-align: center;
    box-shadow: 0px 0px 0.5em black;
}

.msg {
    margin: 0.5em;
    margin-left: 3em;
    padding: .5em;
    padding-top: 1.5em;
    position: relative;
    background-color: white;
    border-radius: 0 .6em .6em .6em;
    box-shadow: 0px 0px 0.5em black;
    clip-path: inset(-0.5em -5em -0.5em -5em);
    word-wrap:break-word !important;
    display: flex;
    flex-wrap: wrap;
}

.msg::before {
    width: 2em;
    height: 2em;
    border: .5em solid white;
    border-radius: 1.4em;
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    margin-top: -0.6em;
    margin-left: -2.44em;
    display: inline-block;
    z-index: -1;
    clip: rect(0.6em, 3em, 1.5em, 2em);
}

.mymsg {
    margin-left: 0.5em;
    margin-right: 3em;
    background-color: #ffd;
    border-radius: .6em 0 .6em .6em;
    padding-top: .5em;
}

.mymsg::before {
    left: inherit;
    right: 0;
    margin-left: inherit;
    margin-right: -2.44em;
    border-color: #ffc;
    clip: rect(0.6em, 2em, 1.5em, 0);
}

.nick {
    margin-top: -1.4em;
    display: inline-block;
    cursor: pointer;
    font-weight: bold;
    position: absolute;
}

.mymsg .nick {
    display: none;
}

.time {
    order: 4;
    right: .5em;
    font-size:70%;
    color: #777;
    align-items: flex-end;
    margin-left: auto;
    margin-top: auto;
}

.mymsg .time {
    margin-top: inherit;
    display: flex;
	align-items: flex-end;
	order: 2;
}

.avatar {
    margin-left: -1.25em;
    font-size:2.3em;
    top: 0;
    left: 0;
    position:absolute;
}

.mymsg .avatar {
    margin-right: -1.25em;
    left: inherit;
    right: 0;
}

.msgtext {
    color: #111;
}
.reactions:not(:empty) {
    flex-basis: calc(100% - 4em);
}
.reactions > span {
    display: inline-block;
    font-size: 70%;
    font-weight: bold;
    border: 1px solid #aaa;
    color: gray;
    padding: .2em .6em;
    border-radius: 1.3em;
    margin-top: .3em;
    margin-right: .5em;
    background-color: #00000008;
    user-select: none;
}

.reactions > span > em {
    font-style: normal;
    cursor: pointer;
}

.reactions_selector {
    position: absolute;
    bottom: .3em;
    left: -2.3em;
    width: 3em;
    height: 1.5em;
    text-align: center;
    cursor: pointer;
    padding-top: 1em;
    /*background-color: green;*/
    opacity: 0;
    transition: opacity 0.5s linear;
}

.noopacity {
    opacity: 1;
}

.reactions_selector:hover {
    font-size: 140%;
    bottom: 0;
}

:not(.mymsg) .reactions_selector:hover {
    left: -2.1em;
    transition: bottom .5s, left .5s, font-size .5s;
}

.mymsg .reactions_selector {
    left: inherit;
    right: -2.3em;
}

.mymsg .reactions_selector:hover {
    left: inherit;
    right: -2.1em;
    transition: bottom .5s, right .5s, font-size .5s;
}

.grnext {
    display: flex;
    flex-wrap: wrap;
    margin-top: -0.15em;
    padding-top: 0.3em;
    border-top-right-radius: 0;
    border-top-left-radius: 0;
    /* We clip it like
        _       _
       | |_____| |
       |         |
       |_________|
       where central part is for the text and everything else for the shadow.
       this 0.08em below together with margin-top: -0.15em; is a workaround for
       shadow clipping Google Chrome bug.
    */
    clip-path: polygon(0 0,
        0 -.5em,
        -5em -.5em,
        -5em calc(100% + .5em),
        calc(100% + 5em) calc(100% + .5em),
        calc(100% + 5em) -.5em,
        100% -.5em,
        100% 0.08em,
        0 0.08em
    );
}
.grnext.mymsg .time {
    margin-right: 0.3em;
}

.grnext .nick {
    display: none;
}

.grnext .avatar {
    display: none;
}

.grnext:before {
    display: none;
}

.msg:has(+ .grnext) {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    margin-bottom: 0;
    padding-bottom: .2em;
}

blockquote {
  background: #f0f0f080;
  border: 0;
  border-left: 3px solid #ccc;
  margin: .5em;
  margin-top: 0;
  padding: 0.5em;
  padding-top: 0;
  border-radius: .2em;
  color: #444;
  cursor: pointer;
}

blockquote > div {
    background: #ccc;
    padding: .1em .5em;
    font-weight: bold;
    margin: 0 -.5em .3em;
}

        </style>
    </head>
    <body>

    </body>
</html>